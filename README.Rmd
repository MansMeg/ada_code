---
output:
  md_document:
    variant: markdown_github
---

<!-- badges: start -->
[![R-CMD-check](https://github.com/MansMeg/ada_pop/workflows/R-CMD-check/badge.svg)](https://github.com/MansMeg/ada_code/actions)
<!-- badges: end -->
  
<!-- README.md is generated from README.Rmd. Please edit that file -->

# A Poll of Polls model

This repository contain code to run the Ada Poll of Polls model using Stan.

To run the models and produce the output:

1. You need to have Stan and Rstan installed. To install Rstan (and Stan), see [Rstan Installation information](https://mc-stan.org/users/interfaces/rstan.html).
2. Install the SwedishPolls R package. See [the install instructions here]().
3. Install the ``adapop`` R package (see below). 
4. Run either 


# The model used

We continuously develop the model and improves it. The actual model we use is set in the [run_ada/ada_cfg.yml]() (``model`` argument). The same model will exist as a stan file in the R package, that you can find in [rpackage/inst/stan_models/](). 

The hyperparameter settings we use are then either set in the config file ([run_ada/ada_cfg.yml]()) or as the default values. The default values are printed when running the model.

Unfortunately we do not have a better description of the model right now. We know that it can be cumbersome to read, but if you have any questions feel free to reach out on twitter or leave an issue [here]() at github.

# R package 

All functionality and tests of implemented functionality is implemented in the R package `ada`.

## Installation
To install, just build the local package (if the repo is cloned):
```{r, eval=FALSE}
devtools::install_local("rpackage")
```

### Access polling data

There are two types of data we can access through the `adapop` package. First, we can access real polling data from Sweden (and Spain, and Germany).

To access the polls data from the R package, use:
```{r}
library(adapop)
data("swedish_polls_curated")
data("swedish_elections")
```

Based on the data we create a polls_data object.

```{r}
pd <- polls_data(y = swedish_polls_curated[, 3:10],
                 house = swedish_polls_curated$Company,
                 publish_date = swedish_polls_curated$PublDate,
                 start_date = swedish_polls_curated$collectPeriodFrom,
                 end_date = swedish_polls_curated$collectPeriodTo,
                 n = swedish_polls_curated$n)
pd
```

To see all available datasets, use:
```{r, eval=FALSE}
data(package = "ada")
```

The real polling data comes both as an original dataset, and a curated dataset that has been curated to be internally consistent. See `rpackage/data-raw` for details exactly on how the curation has been conducted. Every file without suffix `_functions` will create the datasets stored in the R-package.

Documentation on each dataset can be found in the R package docs or in `rpackage/R/docs_data.R`.

To simplify modeling we can also simulate polls data. This can be done using ```simulate_polls()``` as follows.

```{r}
library(ada)
data(x_test)
set.seed(4711)
spd <- simulate_polls(x = x_test[[1]],
                      pd = pd_test,
                      npolls = 150,
                      time_scale = "week",
                      start_date = "2010-01-01")
```

We can also plot the simulated polls with:
```{r, eval=FALSE}
plot(spd, y = "x")
```

### Accessing true state (election) data

In the next step we add information on where we know the true underlying latent state. In the case of real data this is election data (see above). Below we create a dataset with week 3, 4, and 72 being known.

```{r}
true_idx <- c(3, 44, 72)
known_state <- tibble::tibble(date = as.Date("2010-01-01") + lubridate::weeks(true_idx), x = x_test[[1]][true_idx])
known_state
```


### Running a poll of polls model

To fit the model we only need use the `poll_of_polls()` function.

```{r}
output <- capture.output(suppressWarnings(
  pop <- poll_of_polls(y = "x",
                       model = "model8h3",
                       polls_data = spd,
                       time_scale = "week",
                       known_state = known_state,
                       warmup = 4000, 
                       iter = 5000, 
                       chains = 4)
))
```

We can also extract some basic information and the results. 

```{r}
pop
```

The stan object can be found in ```pop5$stan_fit```

```{r}
head(rstan::summary(pop$stan_fit)$summary)[,1:3]
```

We can also quickly visualize the latent series with:

```{r, eval=FALSE}
plot(pop, "x")
```


## Updating/adding new Stan models 

All Stan Code can be found in `rpackage/inst/stan_models`. The purpose is that the stan files should be a part of the rpackage for testing. 

Although local stan_models can be tested direct by:

```
pop5 <- poll_of_polls(...,
                      model = "path/to/my/stan/model.stan",
                      ...)
```

In this way a model can be edited quickly without needing to rebuild the R package.

Note that the filename need to have the same name as the available models to identify how data should be parsed.

Detailed information on the different Stan models can be found [here](https://github.com/MansMeg/ada_pop/tree/master/rpackage/inst/stan_models).

### R code to add for the model

Start by adding the model the function in `stan_polls_data` in the file `stan_data.R`, So that is in the if loop (something we should remove messy to add code that way?)
```
 if(model %in% c("model2","model3","model4","model5","model6","model6b", "model6c","model7","model9")){ #ADD NEW MODEL HERE
```

If one needs to include new data that does not fit any of the previous models create a new function branch
`stan_polls_data_modelnew` in `stan_polls_data_model.R`, otherwise just add it as follows:
```
#' @rdname stan_polls_data_model
#' @export
stan_polls_data_model.modelnew <- stan_polls_data_model.model2
```

The same procedure should be done with `assert_stan_data_model` that checks the data of the model has the right properties.

### R code for storing of stan output

In the file `poll_of_polls.R` update the function `stan_parameters_to_store` to include the variables to keep.

### Testing and developing new Stan models 

Test structures to check different parts of the models can be found in `rpackage/tests/testthat/model*.R`. These test scripts is made to simplify development by supplying test models and data.

# Real Data Experiments

The experiment on real data consists of two steps. (1) First we run models through bash, and then (2) we create a model report for the given models.

## (1) Running the models from bash

See ```bash_runs``` folder. 

The ```run_model3.R``` is the R script that runs the model and ```model_runs/modelX.sh``` is the bash script used to run a model. Helper scripts can be found in ```bash_scripts```.


## (2) Write Model Reports
The bash scripts output model files (in ```model_output```).

In the folder ```rmd_reports```, the different model reports are contained. Use the latest version of the model reports.



